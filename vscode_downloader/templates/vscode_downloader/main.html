<!DOCTYPE html>
<html>

<head>
    <title>VSCode Extensions Downloader</title>
    <style>
        .extension-list {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .extension-input {
            width: 100%;
            height: 100px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        .helper-text {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .parse-button,
        .download-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .parse-button:hover,
        .download-button:hover {
            background-color: #005999;
        }

        .download-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .extension-item {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .extension-item input[type="checkbox"] {
            margin-right: 10px;
        }

        /* Loading spinner styles */
        .loading-spinner {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007acc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #666;
            font-size: 14px;
        }

        .download-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .download-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .download-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Detailed progress styles */
        .progress-container {
            margin-top: 15px;
            display: none;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #007acc;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .progress-details {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .progress-detail-item {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .progress-detail-item.success {
            color: #155724;
        }

        .progress-detail-item.error {
            color: #721c24;
        }

        .progress-detail-item.info {
            color: #0c5460;
        }
    </style>
</head>

<body>
    <div class="extension-list">
        <h1>VSCode Extensions Downloader</h1>

        <div class="input-section">
            <h2>Input Extensions</h2>
            <p class="helper-text">Paste your extensions list (one per line or in JSON format from devcontainer.json)
            </p>
            <textarea class="extension-input" name="extension_input" placeholder='Example formats:
ms-python.python
njpwerner.autodocstring

or

"extensions": [
    "ms-python.python",
    "njpwerner.autodocstring"
]'></textarea>
            <button type="button" class="parse-button" onclick="parseExtensions()">Parse Extensions</button>
        </div>

        <form id="extension-form">
            {% csrf_token %}
            <div id="parsed-extensions">
                {% for extension in extensions %}
                <div class="extension-item">
                    <input type="checkbox" id="{{ extension.id }}" name="selected_extensions"
                        value="{{ extension.id }}">
                    <label for="{{ extension.id }}">
                        <strong>{{ extension.id }}</strong>
                    </label>
                </div>
                {% endfor %}
            </div>

            <!-- Loading spinner -->
            <div id="loading-spinner" class="loading-spinner">
                <div class="spinner"></div>
                <div class="loading-text">Preparing download...</div>
            </div>

            <!-- Progress container -->
            <div id="progress-container" class="progress-container">
                <div class="progress-bar-container">
                    <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%">0%</div>
                </div>
                <div id="progress-details" class="progress-details"></div>
            </div>

            <!-- Download status -->
            <div id="download-status" class="download-status"></div>

            <button type="submit" class="download-button" id="download-button">Download Selected Extensions</button>
        </form>
    </div>

    <script>
        function parseExtensions() {
            const input = document.querySelector('.extension-input').value;
            let extensions = [];

            // Try parsing as JSON first
            try {
                const jsonData = JSON.parse(input);
                if (Array.isArray(jsonData.extensions)) {
                    extensions = jsonData.extensions;
                }
            } catch {
                // If not JSON, split by newlines and filter empty lines
                extensions = input.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !line.startsWith('#'));
            }

            // Update the parsed extensions section
            const parsedSection = document.getElementById('parsed-extensions');
            parsedSection.innerHTML = extensions.map(ext => `
                <div class="extension-item">
                    <input type="checkbox" id="${ext}" name="selected_extensions" value="${ext}">
                    <label for="${ext}">
                        <strong>${ext}</strong>
                    </label>
                </div>
            `).join('');
        }

        // Handle form submission with loading feedback
        document.getElementById('extension-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const selectedExtensions = Array.from(document.querySelectorAll('input[name="selected_extensions"]:checked'))
                .map(checkbox => checkbox.value);

            if (selectedExtensions.length === 0) {
                showStatus('Please select at least one extension to download.', 'error');
                return;
            }

            // Show loading spinner
            const spinner = document.getElementById('loading-spinner');
            const progressContainer = document.getElementById('progress-container');
            const downloadButton = document.getElementById('download-button');
            const status = document.getElementById('download-status');

            spinner.style.display = 'flex';
            progressContainer.style.display = 'block';
            downloadButton.disabled = true;
            downloadButton.textContent = 'Preparing Download...';
            status.style.display = 'none';

            // Prepare data for API
            const data = {
                extensions: selectedExtensions.map(ext => {
                    const [publisher, extension] = ext.split('.');
                    return {
                        publisher: publisher,
                        extension: extension,
                        version: 'latest', // You might want to make this configurable
                        targetPlatform: 'win32-x64' // You might want to make this configurable
                    };
                })
            };

            // Start bulk download
            fetch('/vscode_downloader/api/bulk-download/start/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    const downloadId = data.download_id;
                    monitorBulkDownload(downloadId);
                })
                .catch(error => {
                    // Hide loading spinner
                    spinner.style.display = 'none';
                    progressContainer.style.display = 'none';
                    downloadButton.disabled = false;
                    downloadButton.textContent = 'Download Selected Extensions';

                    showStatus(`Download failed: ${error.message}`, 'error');
                });
        });

        function monitorBulkDownload(downloadId) {
            const checkStatus = () => {
                fetch(`/vscode_downloader/api/bulk-download/status/${downloadId}/`)
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(data);

                        if (data.status === 'completed') {
                            // Download completed, trigger native browser download
                            // This bypasses McAfee Web Gateway interference
                            window.location.href = `/vscode_downloader/api/bulk-download/zip/${downloadId}/`;
                            return null; // No blob to process
                        } else if (data.status === 'error') {
                            throw new Error(data.current_file || 'Download failed');
                        } else {
                            // Continue monitoring
                            setTimeout(checkStatus, 1000);
                            return null;
                        }
                    })
                    .then(result => {
                        if (result === null) {
                            // Native download was triggered, hide loading spinner
                            const spinner = document.getElementById('loading-spinner');
                            const progressContainer = document.getElementById('progress-container');
                            const downloadButton = document.getElementById('download-button');

                            spinner.style.display = 'none';
                            progressContainer.style.display = 'none';
                            downloadButton.disabled = false;
                            downloadButton.textContent = 'Download Selected Extensions';

                            showStatus('Download started! Your browser should begin downloading the file.', 'success');
                        }
                    })
                    .catch(error => {
                        // Hide loading spinner
                        const spinner = document.getElementById('loading-spinner');
                        const progressContainer = document.getElementById('progress-container');
                        const downloadButton = document.getElementById('download-button');

                        spinner.style.display = 'none';
                        progressContainer.style.display = 'none';
                        downloadButton.disabled = false;
                        downloadButton.textContent = 'Download Selected Extensions';

                        showStatus(`Download failed: ${error.message}`, 'error');
                    });
            };

            checkStatus();
        }

        function updateProgress(data) {
            const progressBar = document.getElementById('progress-bar-fill');
            const progressDetails = document.getElementById('progress-details');
            const downloadButton = document.getElementById('download-button');

            // Update progress bar
            progressBar.style.width = `${data.progress}%`;
            progressBar.textContent = `${data.progress}%`;

            // Update button text based on status
            if (data.status === 'downloading') {
                downloadButton.textContent = `Downloading... (${data.downloaded_files}/${data.total_files})`;
            } else if (data.status === 'packaging') {
                downloadButton.textContent = 'Packaging ZIP...';
            } else if (data.status === 'completed') {
                downloadButton.textContent = 'Download Complete!';
            }

            // Update progress details
            if (data.details && data.details.length > 0) {
                progressDetails.innerHTML = data.details.map(detail => {
                    let className = 'progress-detail-item';
                    if (detail.includes('✓')) {
                        className += ' success';
                    } else if (detail.includes('✗')) {
                        className += ' error';
                    } else {
                        className += ' info';
                    }
                    return `<div class="${className}">${detail}</div>`;
                }).join('');

                // Scroll to bottom
                progressDetails.scrollTop = progressDetails.scrollHeight;
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('download-status');
            status.textContent = message;
            status.className = `download-status ${type}`;
            status.style.display = 'block';

            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>

</html>